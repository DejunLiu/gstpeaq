#include "earmodel.h"
#include "stdlib.h"

/* allowable tolerance of relative error */
#define RELDELTA 0.00005
/* allowable tolerance of absolute error */
#define DELTA 0.000005

static gdouble fft_ref_data[] = { 45.753615, 22360.651865,
  4986.494394, 1246.108826, 498.382618, 249.176501, 142.381088,
  88.985474, 59.322029, 41.524317, 30.198687, 22.648378, 17.421312,
  13.687744, 10.949830, 8.896422, 7.326190, 6.104916, 5.140767,
  4.369459, 3.745077, 3.234227, 2.812228, 2.460568, 2.165180,
  1.915240, 1.702333, 1.519845, 1.362532, 1.226196, 1.107455,
  1.003559, 0.912258, 0.831701, 0.760353, 0.696933, 0.640371,
  0.589765, 0.544350, 0.503478, 0.466595, 0.433225, 0.402961,
  0.375449, 0.350383, 0.327497, 0.306560, 0.287369, 0.269745,
  0.253531, 0.238590, 0.224798, 0.212048, 0.200243, 0.189296,
  0.179132, 0.169682, 0.160884, 0.152683, 0.145029, 0.137877,
  0.131186, 0.124921, 0.119048, 0.113536, 0.108359, 0.103491,
  0.098910, 0.094594, 0.090526, 0.086686, 0.083061, 0.079634,
  0.076392, 0.073324, 0.070417, 0.067661, 0.065047, 0.062565,
  0.060208, 0.057967, 0.055836, 0.053807, 0.051875, 0.050035,
  0.048279, 0.046605, 0.045007, 0.043481, 0.042023, 0.040629,
  0.039295, 0.038020, 0.036798, 0.035628, 0.034507, 0.033432,
  0.032401, 0.031412, 0.030463, 0.029551, 0.028675, 0.027833,
  0.027023, 0.026245, 0.025496, 0.024775, 0.024080, 0.023411,
  0.022767, 0.022146, 0.021547, 0.020969, 0.020412, 0.019874,
  0.019355, 0.018853, 0.018369, 0.017901, 0.017448, 0.017011,
  0.016588, 0.016178, 0.015782, 0.015399, 0.015028, 0.014668,
  0.014320, 0.013983, 0.013656, 0.013339, 0.013032, 0.012734,
  0.012445, 0.012164, 0.011892, 0.011628, 0.011372, 0.011122,
  0.010880, 0.010645, 0.010417, 0.010195, 0.009979, 0.009769,
  0.009565, 0.009367, 0.009173, 0.008986, 0.008803, 0.008625,
  0.008451, 0.008283, 0.008118, 0.007958, 0.007802, 0.007650,
  0.007502, 0.007358, 0.007217, 0.007080, 0.006946, 0.006815,
  0.006688, 0.006564, 0.006443, 0.006324, 0.006209, 0.006096,
  0.005986, 0.005879, 0.005774, 0.005671, 0.005571, 0.005473,
  0.005378, 0.005284, 0.005193, 0.005104, 0.005016, 0.004931,
  0.004848, 0.004766, 0.004686, 0.004608, 0.004532, 0.004457,
  0.004384, 0.004312, 0.004242, 0.004174, 0.004106, 0.004041,
  0.003976, 0.003913, 0.003851, 0.003791, 0.003732, 0.003674,
  0.003617, 0.003561, 0.003506, 0.003453, 0.003400, 0.003349,
  0.003298, 0.003249, 0.003200, 0.003153, 0.003106, 0.003060,
  0.003016, 0.002971, 0.002928, 0.002886, 0.002844, 0.002803,
  0.002763, 0.002724, 0.002685, 0.002647, 0.002610, 0.002574,
  0.002538, 0.002503, 0.002468, 0.002434, 0.002401, 0.002368,
  0.002335, 0.002304, 0.002273, 0.002242, 0.002212, 0.002182,
  0.002153, 0.002125, 0.002097, 0.002069, 0.002042, 0.002016,
  0.001989, 0.001964, 0.001938, 0.001913, 0.001889, 0.001865,
  0.001841, 0.001818, 0.001795, 0.001772, 0.001750, 0.001728,
  0.001706, 0.001685, 0.001664, 0.001644, 0.001624, 0.001604,
  0.001584, 0.001565, 0.001546, 0.001527, 0.001509, 0.001491,
  0.001473, 0.001456, 0.001438, 0.001421, 0.001404, 0.001388,
  0.001372, 0.001356, 0.001340, 0.001324, 0.001309, 0.001294,
  0.001279, 0.001264, 0.001250, 0.001235, 0.001221, 0.001208,
  0.001194, 0.001180, 0.001167, 0.001154, 0.001141, 0.001129,
  0.001116, 0.001104, 0.001092, 0.001079, 0.001068, 0.001056,
  0.001044, 0.001033, 0.001022, 0.001011, 0.001000, 0.000989,
  0.000979, 0.000968, 0.000958, 0.000948, 0.000937, 0.000928,
  0.000918, 0.000908, 0.000899, 0.000889, 0.000880, 0.000871,
  0.000862, 0.000853, 0.000844, 0.000835, 0.000827, 0.000818,
  0.000810, 0.000801, 0.000793, 0.000785, 0.000777, 0.000769,
  0.000762, 0.000754, 0.000746, 0.000739, 0.000732, 0.000724,
  0.000717, 0.000710, 0.000703, 0.000696, 0.000689, 0.000682,
  0.000676, 0.000669, 0.000663, 0.000656, 0.000650, 0.000643,
  0.000637, 0.000631, 0.000625, 0.000619, 0.000613, 0.000607,
  0.000601, 0.000596, 0.000590, 0.000584, 0.000579, 0.000573,
  0.000568, 0.000563, 0.000557, 0.000552, 0.000547, 0.000542,
  0.000537, 0.000532, 0.000527, 0.000522, 0.000517, 0.000513,
  0.000508, 0.000503, 0.000499, 0.000494, 0.000490, 0.000485,
  0.000481, 0.000476, 0.000472, 0.000468, 0.000463, 0.000459,
  0.000455, 0.000451, 0.000447, 0.000443, 0.000439, 0.000435,
  0.000431, 0.000428, 0.000424, 0.000420, 0.000416, 0.000413,
  0.000409, 0.000405, 0.000402, 0.000398, 0.000395, 0.000391,
  0.000388, 0.000385, 0.000381, 0.000378, 0.000375, 0.000371,
  0.000368, 0.000365, 0.000362, 0.000359, 0.000356, 0.000353,
  0.000350, 0.000347, 0.000344, 0.000341, 0.000338, 0.000335,
  0.000332, 0.000329, 0.000327, 0.000324, 0.000321, 0.000319,
  0.000316, 0.000313, 0.000311, 0.000308, 0.000305, 0.000303,
  0.000300, 0.000298, 0.000295, 0.000293, 0.000291, 0.000288,
  0.000286, 0.000283, 0.000281, 0.000279, 0.000276, 0.000274,
  0.000272, 0.000270, 0.000268, 0.000265, 0.000263, 0.000261,
  0.000259, 0.000257, 0.000255, 0.000253, 0.000251, 0.000249,
  0.000247, 0.000245, 0.000243, 0.000241, 0.000239, 0.000237,
  0.000235, 0.000233, 0.000231, 0.000229, 0.000228, 0.000226,
  0.000224, 0.000222, 0.000220, 0.000219, 0.000217, 0.000215,
  0.000213, 0.000212, 0.000210, 0.000208, 0.000207, 0.000205,
  0.000204, 0.000202, 0.000200, 0.000199, 0.000197, 0.000196,
  0.000194, 0.000193, 0.000191, 0.000190, 0.000188, 0.000187,
  0.000185, 0.000184, 0.000182, 0.000181, 0.000180, 0.000178,
  0.000177, 0.000175, 0.000174, 0.000173, 0.000171, 0.000170,
  0.000169, 0.000167, 0.000166, 0.000165, 0.000164, 0.000162,
  0.000161, 0.000160, 0.000159, 0.000157, 0.000156, 0.000155,
  0.000154, 0.000153, 0.000152, 0.000150, 0.000149, 0.000148,
  0.000147, 0.000146, 0.000145, 0.000144, 0.000143, 0.000141,
  0.000140, 0.000139, 0.000138, 0.000137, 0.000136, 0.000135,
  0.000134, 0.000133, 0.000132, 0.000131, 0.000130, 0.000129,
  0.000128, 0.000127, 0.000126, 0.000125, 0.000124, 0.000123,
  0.000122, 0.000122, 0.000121, 0.000120, 0.000119, 0.000118,
  0.000117, 0.000116, 0.000115, 0.000114, 0.000114, 0.000113,
  0.000112, 0.000111, 0.000110, 0.000109, 0.000109, 0.000108,
  0.000107, 0.000106, 0.000105, 0.000105, 0.000104, 0.000103,
  0.000102, 0.000101, 0.000101, 0.000100, 0.000099, 0.000098,
  0.000098, 0.000097, 0.000096, 0.000096, 0.000095, 0.000094,
  0.000093, 0.000093, 0.000092, 0.000091, 0.000091, 0.000090,
  0.000089, 0.000089, 0.000088, 0.000087, 0.000087, 0.000086,
  0.000085, 0.000085, 0.000084, 0.000083, 0.000083, 0.000082,
  0.000082, 0.000081, 0.000080, 0.000080, 0.000079, 0.000079,
  0.000078, 0.000077, 0.000077, 0.000076, 0.000076, 0.000075,
  0.000075, 0.000074, 0.000073, 0.000073, 0.000072, 0.000072,
  0.000071, 0.000071, 0.000070, 0.000070, 0.000069, 0.000069,
  0.000068, 0.000068, 0.000067, 0.000067, 0.000066, 0.000066,
  0.000065, 0.000065, 0.000064, 0.000064, 0.000063, 0.000063,
  0.000062, 0.000062, 0.000061, 0.000061, 0.000060, 0.000060,
  0.000059, 0.000059, 0.000058, 0.000058, 0.000058, 0.000057,
  0.000057, 0.000056, 0.000056, 0.000055, 0.000055, 0.000055,
  0.000054, 0.000054, 0.000053, 0.000053, 0.000052, 0.000052,
  0.000052, 0.000051, 0.000051, 0.000050, 0.000050, 0.000050,
  0.000049, 0.000049, 0.000049, 0.000048, 0.000048, 0.000047,
  0.000047, 0.000047, 0.000046, 0.000046, 0.000046, 0.000045,
  0.000045, 0.000045, 0.000044, 0.000044, 0.000044, 0.000043,
  0.000043, 0.000042, 0.000042, 0.000042, 0.000041, 0.000041,
  0.000041, 0.000041, 0.000040, 0.000040, 0.000040, 0.000039,
  0.000039, 0.000039, 0.000038, 0.000038, 0.000038, 0.000037,
  0.000037, 0.000037, 0.000036, 0.000036, 0.000036, 0.000036,
  0.000035, 0.000035, 0.000035, 0.000034, 0.000034, 0.000034,
  0.000034, 0.000033, 0.000033, 0.000033, 0.000033, 0.000032,
  0.000032, 0.000032, 0.000031, 0.000031, 0.000031, 0.000031,
  0.000030, 0.000030, 0.000030, 0.000030, 0.000029, 0.000029,
  0.000029, 0.000029, 0.000028, 0.000028, 0.000028, 0.000028,
  0.000027, 0.000027, 0.000027, 0.000027, 0.000027, 0.000026,
  0.000026, 0.000026, 0.000026, 0.000025, 0.000025, 0.000025,
  0.000025, 0.000025, 0.000024, 0.000024, 0.000024, 0.000024,
  0.000023, 0.000023, 0.000023, 0.000023, 0.000023, 0.000022,
  0.000022, 0.000022, 0.000022, 0.000022, 0.000021, 0.000021,
  0.000021, 0.000021, 0.000021, 0.000020, 0.000020, 0.000020,
  0.000020, 0.000020, 0.000020, 0.000019, 0.000019, 0.000019,
  0.000019, 0.000019, 0.000018, 0.000018, 0.000018, 0.000018,
  0.000018, 0.000018, 0.000017, 0.000017, 0.000017, 0.000017,
  0.000017, 0.000017, 0.000016, 0.000016, 0.000016, 0.000016,
  0.000016, 0.000016, 0.000015, 0.000015, 0.000015, 0.000015,
  0.000015, 0.000015, 0.000015, 0.000014, 0.000014, 0.000014,
  0.000014, 0.000014, 0.000014, 0.000014, 0.000013, 0.000013,
  0.000013, 0.000013, 0.000013, 0.000013, 0.000013, 0.000012,
  0.000012, 0.000012, 0.000012, 0.000012, 0.000012, 0.000012,
  0.000012, 0.000011, 0.000011, 0.000011, 0.000011, 0.000011,
  0.000011, 0.000011, 0.000011, 0.000010, 0.000010, 0.000010,
  0.000010, 0.000010, 0.000010, 0.000010, 0.000010, 0.000010,
  0.000009, 0.000009, 0.000009, 0.000009, 0.000009, 0.000009,
  0.000009, 0.000009, 0.000009, 0.000008, 0.000008, 0.000008,
  0.000008, 0.000008, 0.000008, 0.000008, 0.000008, 0.000008,
  0.000008, 0.000007, 0.000007, 0.000007, 0.000007, 0.000007,
  0.000007, 0.000007, 0.000007, 0.000007, 0.000007, 0.000006,
  0.000006, 0.000006, 0.000006, 0.000006, 0.000006, 0.000006,
  0.000006, 0.000006, 0.000006, 0.000006, 0.000006, 0.000005,
  0.000005, 0.000005, 0.000005, 0.000005, 0.000005, 0.000005,
  0.000005, 0.000005, 0.000005, 0.000005, 0.000005, 0.000005,
  0.000004, 0.000004, 0.000004, 0.000004, 0.000004, 0.000004,
  0.000004, 0.000004, 0.000004, 0.000004, 0.000004, 0.000004,
  0.000004, 0.000004, 0.000004, 0.000003, 0.000003, 0.000003,
  0.000003, 0.000003, 0.000003, 0.000003, 0.000003, 0.000003,
  0.000003, 0.000003, 0.000003, 0.000003, 0.000003, 0.000003,
  0.000003, 0.000003, 0.000003, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000
};

static double weighted_fft_ref_data[] = { 0.000000,
  141.467357, 272.377031, 152.374914, 93.913964, 61.709413,
  42.631835, 30.657191, 22.776622, 17.383418, 13.569721, 10.797261,
  8.733477, 7.165486, 5.952751, 4.999966, 4.240947, 3.628759,
  3.129485, 2.718203, 2.376315, 2.089756, 1.847751, 1.641950,
  1.465818, 1.314185, 1.182930, 1.068734, 0.968911, 0.881266,
  0.803994, 0.735604, 0.674854, 0.620706, 0.572286, 0.528857,
  0.489792, 0.454556, 0.422693, 0.393808, 0.367561, 0.343660,
  0.321849, 0.301904, 0.283632, 0.266861, 0.251440, 0.237239,
  0.224138, 0.212035, 0.200836, 0.190460, 0.180834, 0.171891,
  0.163573, 0.155826, 0.148604, 0.141863, 0.135565, 0.129674,
  0.124159, 0.118990, 0.114142, 0.109591, 0.105314, 0.101293,
  0.097508, 0.093943, 0.090583, 0.087413, 0.084421, 0.081595,
  0.078923, 0.076397, 0.074005, 0.071740, 0.069594, 0.067559,
  0.065628, 0.063795, 0.062053, 0.060398, 0.058824, 0.057326,
  0.055899, 0.054540, 0.053244, 0.052008, 0.050827, 0.049700,
  0.048622, 0.047590, 0.046603, 0.045656, 0.044749, 0.043878,
  0.043041, 0.042236, 0.041462, 0.040716, 0.039996, 0.039300,
  0.038628, 0.037978, 0.037347, 0.036735, 0.036140, 0.035562,
  0.034998, 0.034448, 0.033910, 0.033384, 0.032868, 0.032362,
  0.031865, 0.031376, 0.030893, 0.030417, 0.029947, 0.029482,
  0.029021, 0.028565, 0.028112, 0.027661, 0.027214, 0.026768,
  0.026325, 0.025883, 0.025443, 0.025004, 0.024566, 0.024129,
  0.023693, 0.023258, 0.022824, 0.022391, 0.021959, 0.021528,
  0.021098, 0.020670, 0.020243, 0.019818, 0.019396, 0.018975,
  0.018557, 0.018142, 0.017729, 0.017320, 0.016915, 0.016513,
  0.016115, 0.015722, 0.015333, 0.014950, 0.014571, 0.014197,
  0.013830, 0.013468, 0.013112, 0.012762, 0.012419, 0.012082,
  0.011751, 0.011428, 0.011111, 0.010802, 0.010499, 0.010204,
  0.009915, 0.009634, 0.009360, 0.009093, 0.008833, 0.008580,
  0.008335, 0.008096, 0.007864, 0.007639, 0.007421, 0.007209,
  0.007004, 0.006806, 0.006613, 0.006427, 0.006247, 0.006072,
  0.005904, 0.005741, 0.005583, 0.005431, 0.005284, 0.005142,
  0.005005, 0.004873, 0.004745, 0.004622, 0.004503, 0.004388,
  0.004277, 0.004170, 0.004066, 0.003967, 0.003871, 0.003778,
  0.003688, 0.003602, 0.003518, 0.003438, 0.003360, 0.003285,
  0.003212, 0.003142, 0.003074, 0.003009, 0.002946, 0.002885,
  0.002825, 0.002768, 0.002713, 0.002659, 0.002607, 0.002557,
  0.002508, 0.002461, 0.002416, 0.002371, 0.002328, 0.002287,
  0.002246, 0.002207, 0.002168, 0.002131, 0.002095, 0.002060,
  0.002026, 0.001993, 0.001960, 0.001929, 0.001898, 0.001868,
  0.001839, 0.001810, 0.001783, 0.001756, 0.001729, 0.001703,
  0.001678, 0.001653, 0.001629, 0.001605, 0.001582, 0.001560,
  0.001537, 0.001516, 0.001494, 0.001474, 0.001453, 0.001433,
  0.001413, 0.001394, 0.001375, 0.001357, 0.001338, 0.001320,
  0.001303, 0.001285, 0.001268, 0.001252, 0.001235, 0.001219,
  0.001203, 0.001188, 0.001172, 0.001157, 0.001142, 0.001128,
  0.001113, 0.001099, 0.001085, 0.001071, 0.001058, 0.001045,
  0.001031, 0.001019, 0.001006, 0.000993, 0.000981, 0.000969,
  0.000957, 0.000945, 0.000933, 0.000922, 0.000910, 0.000899,
  0.000888, 0.000877, 0.000866, 0.000856, 0.000845, 0.000835,
  0.000825, 0.000815, 0.000805, 0.000795, 0.000786, 0.000776,
  0.000767, 0.000757, 0.000748, 0.000739, 0.000731, 0.000722,
  0.000713, 0.000705, 0.000696, 0.000688, 0.000680, 0.000672,
  0.000664, 0.000656, 0.000648, 0.000640, 0.000633, 0.000625,
  0.000618, 0.000610, 0.000603, 0.000596, 0.000589, 0.000582,
  0.000575, 0.000568, 0.000562, 0.000555, 0.000548, 0.000542,
  0.000536, 0.000529, 0.000523, 0.000517, 0.000511, 0.000505,
  0.000499, 0.000493, 0.000487, 0.000482, 0.000476, 0.000470,
  0.000465, 0.000460, 0.000454, 0.000449, 0.000444, 0.000438,
  0.000433, 0.000428, 0.000423, 0.000418, 0.000413, 0.000409,
  0.000404, 0.000399, 0.000394, 0.000390, 0.000385, 0.000381,
  0.000376, 0.000372, 0.000368, 0.000363, 0.000359, 0.000355,
  0.000351, 0.000347, 0.000343, 0.000339, 0.000335, 0.000331,
  0.000327, 0.000323, 0.000319, 0.000315, 0.000312, 0.000308,
  0.000305, 0.000301, 0.000297, 0.000294, 0.000291, 0.000287,
  0.000284, 0.000280, 0.000277, 0.000274, 0.000271, 0.000267,
  0.000264, 0.000261, 0.000258, 0.000255, 0.000252, 0.000249,
  0.000246, 0.000243, 0.000240, 0.000237, 0.000235, 0.000232,
  0.000229, 0.000226, 0.000224, 0.000221, 0.000218, 0.000216,
  0.000213, 0.000211, 0.000208, 0.000206, 0.000203, 0.000201,
  0.000198, 0.000196, 0.000194, 0.000191, 0.000189, 0.000187,
  0.000185, 0.000182, 0.000180, 0.000178, 0.000176, 0.000174,
  0.000172, 0.000169, 0.000167, 0.000165, 0.000163, 0.000161,
  0.000159, 0.000157, 0.000155, 0.000154, 0.000152, 0.000150,
  0.000148, 0.000146, 0.000144, 0.000143, 0.000141, 0.000139,
  0.000137, 0.000136, 0.000134, 0.000132, 0.000131, 0.000129,
  0.000127, 0.000126, 0.000124, 0.000123, 0.000121, 0.000120,
  0.000118, 0.000117, 0.000115, 0.000114, 0.000112, 0.000111,
  0.000109, 0.000108, 0.000107, 0.000105, 0.000104, 0.000103,
  0.000101, 0.000100, 0.000099, 0.000097, 0.000096, 0.000095,
  0.000094, 0.000092, 0.000091, 0.000090, 0.000089, 0.000088,
  0.000087, 0.000085, 0.000084, 0.000083, 0.000082, 0.000081,
  0.000080, 0.000079, 0.000078, 0.000077, 0.000076, 0.000075,
  0.000074, 0.000073, 0.000072, 0.000071, 0.000070, 0.000069,
  0.000068, 0.000067, 0.000066, 0.000065, 0.000064, 0.000064,
  0.000063, 0.000062, 0.000061, 0.000060, 0.000059, 0.000058,
  0.000058, 0.000057, 0.000056, 0.000055, 0.000055, 0.000054,
  0.000053, 0.000052, 0.000052, 0.000051, 0.000050, 0.000049,
  0.000049, 0.000048, 0.000047, 0.000047, 0.000046, 0.000045,
  0.000045, 0.000044, 0.000043, 0.000043, 0.000042, 0.000042,
  0.000041, 0.000040, 0.000040, 0.000039, 0.000039, 0.000038,
  0.000037, 0.000037, 0.000036, 0.000036, 0.000035, 0.000035,
  0.000034, 0.000034, 0.000033, 0.000033, 0.000032, 0.000032,
  0.000031, 0.000031, 0.000030, 0.000030, 0.000029, 0.000029,
  0.000029, 0.000028, 0.000028, 0.000027, 0.000027, 0.000026,
  0.000026, 0.000026, 0.000025, 0.000025, 0.000024, 0.000024,
  0.000024, 0.000023, 0.000023, 0.000023, 0.000022, 0.000022,
  0.000021, 0.000021, 0.000021, 0.000020, 0.000020, 0.000020,
  0.000019, 0.000019, 0.000019, 0.000019, 0.000018, 0.000018,
  0.000018, 0.000017, 0.000017, 0.000017, 0.000017, 0.000016,
  0.000016, 0.000016, 0.000015, 0.000015, 0.000015, 0.000015,
  0.000014, 0.000014, 0.000014, 0.000014, 0.000013, 0.000013,
  0.000013, 0.000013, 0.000013, 0.000012, 0.000012, 0.000012,
  0.000012, 0.000011, 0.000011, 0.000011, 0.000011, 0.000011,
  0.000011, 0.000010, 0.000010, 0.000010, 0.000010, 0.000010,
  0.000009, 0.000009, 0.000009, 0.000009, 0.000009, 0.000009,
  0.000008, 0.000008, 0.000008, 0.000008, 0.000008, 0.000008,
  0.000008, 0.000007, 0.000007, 0.000007, 0.000007, 0.000007,
  0.000007, 0.000007, 0.000006, 0.000006, 0.000006, 0.000006,
  0.000006, 0.000006, 0.000006, 0.000006, 0.000006, 0.000005,
  0.000005, 0.000005, 0.000005, 0.000005, 0.000005, 0.000005,
  0.000005, 0.000005, 0.000005, 0.000004, 0.000004, 0.000004,
  0.000004, 0.000004, 0.000004, 0.000004, 0.000004, 0.000004,
  0.000004, 0.000004, 0.000004, 0.000003, 0.000003, 0.000003,
  0.000003, 0.000003, 0.000003, 0.000003, 0.000003, 0.000003,
  0.000003, 0.000003, 0.000003, 0.000003, 0.000003, 0.000003,
  0.000003, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000002, 0.000002, 0.000002, 0.000002, 0.000002, 0.000002,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001,
  0.000001, 0.000001, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000
};

static double band_power_ref[] = { 10070.506160,
  4263.630293, 2000.800274, 1018.921347, 554.189968, 315.087231,
  188.650729, 118.502702, 76.834886, 51.192030, 34.925054, 24.323627,
  17.251637, 12.433523, 8.896919, 6.491739, 4.908398, 3.747785,
  2.811258, 2.146576, 1.693604, 1.294914, 1.025499, 0.809196,
  0.641270, 0.511278, 0.413427, 0.327711, 0.267883, 0.218331,
  0.176676, 0.144516, 0.118996, 0.098197, 0.081290, 0.067552,
  0.056373, 0.046830, 0.039459, 0.033431, 0.028098, 0.024071,
  0.020455, 0.017623, 0.015237, 0.013235, 0.011563, 0.010169,
  0.009006, 0.008034, 0.007186, 0.006495, 0.005873, 0.005346,
  0.004874, 0.004443, 0.004041, 0.003646, 0.003267, 0.002879,
  0.002497, 0.002117, 0.001751, 0.001406, 0.001100, 0.000835,
  0.000618, 0.000448, 0.000321, 0.000228, 0.000184, 0.000117,
  0.000085, 0.000063, 0.000048, 0.000037, 0.000029, 0.000023,
  0.000019, 0.000015, 0.000012, 0.000010, 0.000008, 0.000006,
  0.000005, 0.000004, 0.000003, 0.000002, 0.000002, 0.000001,
  0.000001, 0.000001, 0.000001, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
  0.000000
};

static double unsmeared_excitation_ref[] = { 4444.479818,
  3458.307890, 2476.902582, 1687.148923, 1111.845019, 717.415269,
  458.489189, 292.859403, 188.108327, 122.111063, 80.437553,
  53.936208, 36.897706, 25.785306, 18.408591, 13.476842, 10.146485,
  7.841501, 6.204263, 5.033303, 4.186348, 3.554651, 3.083758,
  2.725308, 2.448974, 2.233633, 2.064062, 1.927977, 1.819100,
  1.730369, 1.657093, 1.596339, 1.545507, 1.502504, 1.465769,
  1.434099, 1.406543, 1.382332, 1.360980, 1.341966, 1.324860,
  1.309427, 1.295362, 1.282500, 1.270660, 1.259699, 1.249506,
  1.239988, 1.231065, 1.222667, 1.214735, 1.207222, 1.200082,
  1.193279, 1.186779, 1.180552, 1.174572, 1.168816, 1.163268,
  1.157911, 1.152737, 1.147739, 1.142915, 1.138266, 1.133791,
  1.129492, 1.125366, 1.121408, 1.117612, 1.113969, 1.110471,
  1.107100, 1.103854, 1.100725, 1.097704, 1.094785, 1.091963,
  1.089233, 1.086590, 1.084031, 1.081553, 1.079152, 1.076826,
  1.074571, 1.072386, 1.070268, 1.068214, 1.066223, 1.064293,
  1.062420, 1.060605, 1.058844, 1.057136, 1.055479, 1.053872,
  1.052314, 1.050802, 1.049337, 1.047917, 1.046542, 1.045214,
  1.043933, 1.042706, 1.041540, 1.040452, 1.039467, 1.038630,
  1.038030, 1.037901
};

static double excitation_ref[] = {
  1471383.154403, 1784862.319735, 2101162.156197, 2338471.350385,
  2499214.928898, 2571730.433658, 2579416.333721, 2529922.626285,
  2444390.214750, 2332168.186978, 2206250.638417, 2073217.021524, 
  1939180.266427, 1807914.572103, 1680942.192057, 1561356.107444,
  1449900.757658, 1346679.568437, 1251088.135018, 1163169.255593,
  1082978.131305, 1009288.718863, 942152.978451, 880816.475225, 824866.151709,
  773810.888644, 727258.694447, 684545.444266, 645739.615593, 610314.929805, 
  577864.997361, 548260.693315, 521300.995058, 496757.835542, 474450.514958, 
  454227.589690, 435953.597901, 419496.213725, 404869.224749, 391981.220355,
  380728.951700, 371180.695629, 363262.385575, 357039.639252, 352528.344745,
  349773.798317, 348840.194206, 349810.185964, 352763.857065, 357780.074455,
  364925.163245, 374218.430049, 385632.659205, 399017.183416, 414087.711983,
  430359.532681, 447099.872855, 463293.955467, 477631.774673, 488576.621667, 
  494492.510166, 493837.923811, 485427.021495, 468677.401704, 443887.730700,
  412123.066760, 375266.199841, 335623.185541, 295654.757437, 257586.231306,
  223295.858853, 189816.286922, 161053.808039, 136881.346311, 116887.629073,
  100515.264869, 87164.386849, 76253.860639, 67274.394313, 59796.109652, 
  53471.716579, 48029.415494, 43260.818559, 39011.218117, 35164.945648,
  31638.495337, 28371.870488, 25323.979912, 22466.960114, 19784.374934,
  17267.547433, 14914.647607, 12727.799562, 10712.667788, 8875.860072,
  7224.337046, 5763.377959, 4495.533484, 3419.672996, 2529.820845,
  1815.094177, 1259.713336, 844.000449, 545.506778, 340.815298, 207.355402,
  125.143970, 78.226738, 56.837145
};

static void
assertArrayEquals (gdouble * dut, gdouble * ref, guint len, gchar * var_name)
{
  guint i;
  for (i = 0; i < len; i++) {
    gdouble diff = dut[i] - ref[i];
    gdouble reldiff = 2 * (dut[i] - ref[i]) / (dut[i] + ref[i]);
    if ((diff > DELTA || diff < -DELTA) && 
	(reldiff > RELDELTA || reldiff < -RELDELTA)) {
      g_printf ("%s[%d] = %f != %f (diff = %f, rel = %f)\n", var_name, 
		i, dut[i], ref[i], diff, reldiff);
      exit (1);
    }
  }
}

int
main (int argc, char *argv[])
{
  gint i;
  gfloat input_data[2048];
  PeaqEarModel *ear;
  EarModelOutput output;

  g_type_init ();

  ear = g_object_new (PEAQ_TYPE_EARMODEL, NULL);
  for (i = 0; i < 1024; i++)
    input_data[i] = -1;
  input_data[i++] = 0;
  while (i < 2048)
    input_data[i++] = 1;
  peaq_earmodel_process (ear, input_data, &output);
  for (i = 0; i < 2048; i++)
    input_data[i] = (gfloat) (i - 1024) / 1024;
  peaq_earmodel_process (ear, input_data, &output);

  assertArrayEquals (output.absolute_spectrum, fft_ref_data, 1025,
		     "absolute_spectrum");

  assertArrayEquals (output.weighted_fft, weighted_fft_ref_data, 1025,
		     "weighted_fft");

  assertArrayEquals (output.band_power, band_power_ref, CRITICAL_BAND_COUNT,
		     "band_power");

  assertArrayEquals (output.unsmeared_excitation, unsmeared_excitation_ref,
		     CRITICAL_BAND_COUNT, "unsmeared_excitation");

  assertArrayEquals (output.excitation, excitation_ref, CRITICAL_BAND_COUNT,
		     "excitation");

  return 0;
}
